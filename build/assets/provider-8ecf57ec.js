var L=Object.defineProperty;var v=(d,t,i)=>t in d?L(d,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):d[t]=i;var n=(d,t,i)=>(v(d,typeof t!="symbol"?t+"":t,i),i);import{v as g,D as l,I as T,B as u,J as k,x as y,z as E,K as H,L as c,S as w,M as b,N as S,k as m,O as _,Q as A,w as I,R,U,W as O,X as f,Y as D,Z as M,$,a0 as N,l as C}from"./index-d8397883.js";const Y=Symbol(0);class p{constructor(t){n(this,"Ta");this.X=t}D(){m(this.Ta)&&this.Ua()}E(){_(this.Ta)&&window.cancelAnimationFrame(this.Ta),this.Ta=void 0}Ua(){this.Ta=window.requestAnimationFrame(()=>{m(this.Ta)||(this.X(),this.Ua())})}}const q=d=>A(d);class F{constructor(t){n(this,"Ha");n(this,"e",null);n(this,"Ia",null);n(this,"Fa",{});n(this,"Ga",new Set);this.l=t}get instance(){return this.e}setup(t,i){this.Ha=i;const e=g(i.$store.streamType).includes("live"),r=g(i.$store.streamType).includes("ll-");this.e=new t({lowLatencyMode:r,backBufferLength:r?4:e?8:void 0,renderTextTracksNatively:!1,...this.Fa});const s=this.Ja.bind(this);for(const a of Object.values(t.Events))this.e.on(a,s);this.e.on(t.Events.ERROR,this.x.bind(this));for(const a of this.Ga)a(this.e);i.player.dispatchEvent(new l("hls-instance",{detail:this.e})),this.e.attachMedia(this.l),this.e.on(t.Events.AUDIO_TRACK_SWITCHED,this.Ka.bind(this)),this.e.on(t.Events.LEVEL_SWITCHED,this.La.bind(this)),this.e.on(t.Events.LEVEL_LOADED,this.Ma.bind(this)),this.e.on(t.Events.NON_NATIVE_TEXT_TRACKS_FOUND,this.Na.bind(this)),this.e.on(t.Events.CUES_PARSED,this.Oa.bind(this)),i.qualities[T]=this.Pa.bind(this),u(i.qualities,"change",this.wa.bind(this)),u(i.audioTracks,"change",this.Qa.bind(this)),this.Ia=k(this.Ra.bind(this))}Ra(){if(!this.Ha.$store.live())return;const t=new p(this.Sa.bind(this));return t.D(),t.E.bind(t)}Sa(){var t;this.Ha.$store.liveSyncPosition.set(((t=this.e)==null?void 0:t.liveSyncPosition)??1/0)}Ja(t,i){this.Ha.player.dispatchEvent(new l(q(t),{detail:i}))}Na(t,i){const e=new l(t,{detail:i});let r=-1;for(let s=0;s<i.tracks.length;s++){const a=i.tracks[s],o=a.subtitleTrack??a.closedCaptions,h=new y({id:`hls-${a.kind}${s}`,src:o==null?void 0:o.url,label:a.label,language:o==null?void 0:o.lang,kind:a.kind});h[E]=2,h[H]=()=>{h.mode==="showing"?(this.e.subtitleTrack=s,r=s):r===s&&(this.e.subtitleTrack=-1,r=-1)},a.default&&h.setMode("showing",e),this.Ha.textTracks.add(h,e)}}Oa(t,i){const e=this.Ha.textTracks.getById(`hls-${i.track}`);if(!e)return;const r=new l(t,{detail:i});for(const s of i.cues)s.positionAlign="auto",e.addCue(s,r)}Ka(t,i){const e=this.Ha.audioTracks[i.id];e&&this.Ha.audioTracks[c](e,!0,new l(t,{detail:i}))}La(t,i){const e=this.Ha.qualities[i.level];e&&this.Ha.qualities[c](e,!0,new l(t,{detail:i}))}Ma(t,i){if(this.Ha.$store.canPlay())return;const{type:e,live:r,totalduration:s}=i.details,a=new l(t,{detail:i});this.Ha.delegate.L("stream-type-change",{detail:r?e==="EVENT"&&Number.isFinite(s)?"live:dvr":"live":"on-demand",trigger:a}),this.Ha.delegate.L("duration-change",{detail:s,trigger:a});const o=this.e.media;this.e.currentLevel===-1&&this.Ha.qualities[w](!0,a);for(const h of this.e.audioTracks)this.Ha.audioTracks[b]({id:h.id+"",label:h.name,language:h.lang||"",kind:"main"},a);for(const h of this.e.levels)this.Ha.qualities[b]({width:h.width,height:h.height,codec:h.codecSet,bitrate:h.bitrate},a);o.dispatchEvent(new l("canplay",{trigger:a}))}x(t,i){var e,r,s;if(i.fatal)switch(i.type){case"networkError":(e=this.e)==null||e.startLoad();break;case"mediaError":(r=this.e)==null||r.recoverMediaError();break;default:(s=this.e)==null||s.destroy(),this.e=null;break}}Pa(){this.e&&(this.e.currentLevel=-1)}wa(){const{qualities:t}=this.Ha;!this.e||t.auto||(this.e[t.switch+"Level"]=t.selectedIndex,S&&(this.l.currentTime=this.l.currentTime))}Qa(){const{audioTracks:t}=this.Ha;this.e&&this.e.audioTrack!==t.selectedIndex&&(this.e.audioTrack=t.selectedIndex)}ga(){var t,i;this.Ha&&(this.Ha.qualities[T]=void 0),(t=this.e)==null||t.destroy(),this.e=null,(i=this.Ia)==null||i.call(this),this.Ia=null}}class V{constructor(t,i){n(this,"ma",R());n(this,"Va",!1);n(this,"Ya",!1);n(this,"Za",!1);n(this,"Wa",new p(this.cb.bind(this)));n(this,"vb");n(this,"xb");this.d=t,this.Ha=i,this.ab(),k(this.bb.bind(this)),I(this.La.bind(this))}get e(){return this.d.media}get ia(){return this.Ha.delegate}La(){this.Wa.E(),this.ma.empty()}cb(){const t=this.d.currentTime;this.Ha.$store.currentTime()!==t&&this.Ua(t)}ab(){this.Ta("loadstart",this.v),this.Ta("abort",this._a),this.Ta("emptied",this.db),this.Ta("error",this.x)}eb(){this.Ya||(this.ma.add(this.Ta("loadeddata",this.fb),this.Ta("loadedmetadata",this.gb),this.Ta("canplay",this.q),this.Ta("canplaythrough",this.hb),this.Ta("durationchange",this.ib),this.Ta("play",this.jb),this.Ta("progress",this.kb),this.Ta("stalled",this.lb),this.Ta("suspend",this.mb)),this.Ya=!0)}nb(){this.Za||(this.ma.add(this.Ta("pause",this.ob),this.Ta("playing",this.pb),this.Ta("ratechange",this.qb),this.Ta("seeked",this.rb),this.Ta("seeking",this.sb),this.Ta("ended",this.tb),this.Ta("volumechange",this.m),this.Ta("waiting",this.ub)),this.Za=!0)}Ta(t,i){return u(this.e,t,i.bind(this))}yb(t){}Ua(t,i){this.ia.L("time-update",{detail:{currentTime:Math.min(t,this.Ha.$store.seekableEnd()),played:this.e.played},trigger:i})}v(t){if(this.e.networkState===3){this._a(t);return}this.eb(),this.ia.L("load-start",{trigger:t})}_a(t){this.ia.L("abort",{trigger:t})}db(){this.ia.L("emptied",{trigger:event})}fb(t){this.ia.L("loaded-data",{trigger:t})}gb(t){this.$a(),this.nb(),this.ia.L("volume-change",{detail:{volume:this.e.volume,muted:this.e.muted}}),this.ia.L("loaded-metadata",{trigger:t}),U&&O(this.Ha.$store.source())&&this.ia.da(this.Xa(),t)}Xa(){return{duration:this.e.duration,buffered:this.e.buffered,seekable:this.e.seekable}}$a(){const t=!Number.isFinite(this.e.duration);this.ia.L("stream-type-change",{detail:t?"live":"on-demand"})}jb(t){this.Ha.$store.canPlay&&this.ia.L("play",{trigger:t})}ob(t){this.e.readyState===1&&!this.Va||(this.Va=!1,this.Wa.E(),this.ia.L("pause",{trigger:t}))}q(t){this.ia.da(this.Xa(),t)}hb(t){this.Ha.$store.started()||this.ia.L("can-play-through",{trigger:t,detail:this.Xa()})}pb(t){this.Va=!1,this.ia.L("playing",{trigger:t}),this.Wa.D()}lb(t){this.ia.L("stalled",{trigger:t}),this.e.readyState<3&&(this.Va=!0,this.ia.L("waiting",{trigger:t}))}ub(t){this.e.readyState<3&&(this.Va=!0,this.ia.L("waiting",{trigger:t}))}tb(t){this.Wa.E(),this.Ua(this.e.duration,t),this.ia.L("end",{trigger:t}),this.Ha.$store.loop()?this.wb():this.ia.L("ended",{trigger:t})}bb(){this.Ha.$store.paused()&&u(this.e,"timeupdate",this.v.bind(this))}v(t){this.Ua(this.e.currentTime,t)}ib(t){this.$a(),this.Ha.$store.ended()&&this.Ua(this.e.duration,t),this.ia.L("duration-change",{detail:this.e.duration,trigger:t})}m(t){this.ia.L("volume-change",{detail:{volume:this.e.volume,muted:this.e.muted},trigger:t})}rb(t){this.Ua(this.e.currentTime,t),this.ia.L("seeked",{detail:this.e.currentTime,trigger:t}),Math.trunc(this.e.currentTime)===Math.trunc(this.e.duration)&&f(this.e.duration)>f(this.e.currentTime)&&(this.Ua(this.e.duration,t),this.e.ended||this.Ha.player.dispatchEvent(new l("media-play-request",{trigger:t})))}sb(t){this.ia.L("seeking",{detail:this.e.currentTime,trigger:t})}kb(t){this.ia.L("progress",{detail:{buffered:this.e.buffered,seekable:this.e.seekable},trigger:t})}wb(){D(this.e.controls)&&(this.e.controls=!1),this.Ha.player.dispatchEvent(new l("media-loop-request"))}mb(t){this.ia.L("suspend",{trigger:t})}qb(t){this.ia.L("rate-change",{detail:this.e.playbackRate,trigger:t})}x(t){const i=this.e.error;i&&this.ia.L("error",{detail:{message:i.message,code:i.code,mediaError:i},trigger:t})}}class P{constructor(t,i){this.d=t,this.Ha=i,this.Ta.onaddtrack=this.Va.bind(this),this.Ta.onremovetrack=this.Wa.bind(this),this.Ta.onchange=this.Xa.bind(this),u(this.Ha.audioTracks,"change",this.Ya.bind(this))}get Ta(){return this.d.media.audioTracks}Va(t){const i=t.track;if(i.label==="")return;const e={id:i.id+"",label:i.label,language:i.language,kind:i.kind,selected:!1};this.Ha.audioTracks[b](e,t),i.enabled&&(e.selected=!0)}Wa(t){const i=this.Ha.audioTracks.getById(t.track.id);i&&this.Ha.audioTracks[M](i,t)}Xa(t){let i=this.Ua();if(!i)return;const e=this.Ha.audioTracks.getById(i.id);e&&this.Ha.audioTracks[c](e,!0,t)}Ua(){return Array.from(this.Ta).find(t=>t.enabled)}Ya(t){const{current:i}=t.detail;if(!i)return;const e=this.Ta.getTrackById(i.id);if(e){const r=this.Ua();r&&(r.enabled=!1),e.enabled=!0}}}class B{constructor(t){this.e=t}setup(t){new V(this,t),"audioTracks"in this.media&&new P(this,t)}get type(){return""}get media(){return this.e}get paused(){return this.e.paused}get muted(){return this.e.muted}set muted(t){this.e.muted=t}get volume(){return this.e.volume}set volume(t){this.e.volume=t}get currentTime(){return this.e.currentTime}set currentTime(t){this.e.currentTime=t}get playsinline(){return this.e.hasAttribute("playsinline")}set playsinline(t){$(this.e,"playsinline",t)}get playbackRate(){return this.e.playbackRate}set playbackRate(t){this.e.playbackRate=t}async play(){return this.e.play()}async pause(){return this.e.pause()}async loadSource({src:t},i){this.e.preload=i,N(t)?this.e.srcObject=t:(this.e.srcObject=null,this.e.src=C(t)?t:window.URL.createObjectURL(t)),this.e.load()}}export{B as H,Y as P,F as a};
